
$(document).ready(function(){
	YANA.sectionById = {};
	YANA.initializeSections("homeContentList",YANA.contentSections);
	YANA.initializeSections("homeMetaList",YANA.metaSections);
	YANA.addRssArticleHandler();
    });
    

YANA.initializeSections = function(listId,sections){
    for (var i=0; i < sections.length; i++ ) {
	var s = sections[i];
	YANA.sectionById[s.id]=s;
	//var onclickHtml = ' onclick="return YANA.changePage(\'' + s.id + '\'); " ';
	//var onclickHtml="";
	$("#"+listId).append('<li><a href="#'+ s.id+'Page"><img src="' + s.img + '" alt="' + s.label + '" class="ui-li-icon"></img>' + s.label + '</a></li>');
	$('body').append(YANA.buildPageHtml(s));
	YANA.addPageCreateHandler(s);
    }
};

YANA.buildPageHtml = function (section){
    // TODO: we have to an a rel="external" tag to all links.
    var html = '<section data-role="page" id="' + section.id + 'Page">';
    html += '<header data-role="header" id="' + section.id + 'Header">';
    html += '<h1>' + section.label + '</h1>';
    html += '<a href="#homePage" data-icon="home" data-iconpos="left" data-direction="reverse" class="ui-btn-right">Home</a>';
    html += '</header>';
    html += '<section data-role="content" id="' + section.id + 'Content">';
    if ( section.type === 'rss' ) {
	var listId = section.id + "List";
	html += '<ul data-role="listview" data-inset="true" id="' + listId + '"><li></li></ul>';
    }
    html += '</section></section>';
    return html;
};

YANA.addPageCreateHandler = function(section){
    $('#'+section.id+"Page").live('pagecreate',function(event){
	    if ( section.type === "rss" ) {
		YANA.insertRemoteRss(section);
	    } else if ( section.type === "html" ) {
		YANA.insertRemoteHtml(section);
	    } else if ( section.type === "opensearch" ) {
		//alert("opensearch support pending");
		YANA.insertOpenSearch(section)
	    } else if ( section.type === "favorites" ) {
		YANA.insertFavorites(section);
	    } else {
		alert("unsupported type!" + section.type);
	    }	
	});
};

YANA.addRssArticleHandler = function(){
    $('#articlePage').live('pagecreate',function(event){
	    alert("mein dude. get the url arguments for section and article id.");
	});
}



YANA.refreshListView = function(listId){
    try {
	$('#'+listId).listview('refresh');
    } catch(e) {
	$('#'+listId).listview();
    }
};

YANA.rssTruncate = function(text, length, ellipsis) {    
    // Set length and ellipsis to defaults if not defined
    if (typeof length == 'undefined') var length = 100;
    if (typeof ellipsis == 'undefined') var ellipsis = '...';
    // Return if the text is already lower than the cutoff
    if (text.length < length) return text;
    // Otherwise, check if the last character is a space.
    // If not, keep counting down from the last character
    // until we find a character that is a space
    for (var i = length-1; text.charAt(i) != ' '; i--) {
        length--;
    }
    // The for() loop ends when it finds a space, and the length var
    // has been updated so it doesn't cut in the middle of a word.
    return text.substr(0, length) + ellipsis;
};

YANA.insertRssArticle = function(section,articleId){
    var contentId = "articleContent";
    var html="<p>Insert Article  doesn't work yet. Sorry.</p>";
    $("#"+contentId).html(html);
};

YANA.insertFavorites = function(section){
    var contentId = section.id+"Content";
    var html="<p>Favorites doesn't work yet. Sorry.</p>";
    $("#"+contentId).html(html);
};

YANA.insertOpenSearch = function(section){
    var contentId = section.id+"Content";
    var html="<p>OpenSearch doesn't work yet. Sorry.</p>";
    $("#"+contentId).html(html);
};

YANA.insertRemoteHtml = function(section){
    var contentId = section.id+"Content";
    var htmlUrl   = section.url;
    $.getJSON(
	      "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22"+encodeURIComponent(htmlUrl)+"%22&format=xml&callback=?",
	      function(data) {
		  var html = "";
		  if(data.results[0]){
		      html = YANA.filterYqlHtml(data.results[0]);
		  } else {
		      var errormsg = '<p><a href="' + htmlUrl +'">Error loading html url ' + htmlUrl +'</a></p>';
		      html = errormsg;
		  }
		  $("#"+contentId).html(html);
		  // TODO: reinos: not sure if this will work.
		  $('#'+contentId+'Page :a').attr('rel', 'external');
	      });
};

YANA.filterYqlHtml = function(data){
    // Lifted from: http://icant.co.uk/articles/crossdomain-ajax-with-jquery/error-handling.html
    // filter all the nasties out
    // no body tags
    data = data.replace(/<?\/body[^>]*>/g,'');
    // no linebreaks
    data = data.replace(/[\r|\n]+/g,'');
    // no comments
    data = data.replace(/<--[\S\s]*?-->/g,'');
    // no noscript blocks
    data = data.replace(/<noscript[^>]*>[\S\s]*?<\/noscript>/g,'');
    // no script blocks
    data = data.replace(/<script[^>]*>[\S\s]*?<\/script>/g,'');
    // no self closing scripts
    data = data.replace(/<script.*\/>/,'');
    // [... add as needed ...]
    return data;
};

YANA.insertRemoteRss = function(section) {
    var listId = section.id + "List";
    var rssUrl = section.url;
    var truncationLength = section.truncate;
    $.getJSON(
	      "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D%22"+encodeURIComponent(rssUrl)+"%22&format=json&callback=?",
	      function(data) {
		  var count = 0;
                  //var html="";//"<ul data-role=\"listview\" data-inset=\"true\" id=\"rssList\"> ";
		  var maxEntries = 100;
		  //alert(listId+":"+$("#"+listId).html());
		  $("#"+listId).html("");
		  //grab ever rss item from the json result request
		  // works for dash, pdr: data.query.results.rss.channel.item
		  // works for ehjournal: data.query.results.RDF.item
		  section.data = data;
		  try {
		      $.each(data.query.results.rss.channel.item || data.query.results.entry,function(){
			      //if set up to be infinite or the limit is not reached, keep grabbing items
			      if(maxEntries == 0 || maxEntries>count){
				  var title = this.title;
				  var link = this.link;
				  if ( link instanceof Array ) {
				      link = link[0];
				  }
				  var description = this.description;
				  if ( description instanceof Array ) {
				      var concatenatedDescription = "";
				      for ( var i=0; i < description.length; i++ ) {
					  concatenatedDescription += description[i]+"\n";
				      }
				      description = concatenatedDescription;
				  } else {
				      try {
					  description = $(description).text();
				      } catch (ee) {
					  // what the hell.
				      }
				  }
				  var reducedDescription = YANA.rssTruncate(description,truncationLength);
				  if ( ! reducedDescription ) {
				      reducedDescription = "Unable to get description for some reason (Reinhard will fix).";
				  }
				  //var pubDate = this.pubDate;
				  //alert(JSON.stringify(this,null,2));
				  var thumbnailUrl = this.content ? (this.content.url ? this.content.url : "" ) : "";
				  //var thumbnailUrl = "";
				  var thumbnailHtml = thumbnailUrl ? '<img class="thumbnail" src="' + thumbnailUrl + '" />' : '';
				  //$("#"+listId).append("<li><a rel=\"external\" href='"+link+"'>" + thumbnailHtml +"<h3>"+title+"</h3><p>" + reducedDescription + "</p></a></li>");
				  $("#"+listId).append("<li><a href='#articlePage&s="+section.id+"'>" + thumbnailHtml +"<h3>"+title+"</h3><p>" + reducedDescription + "</p></a></li>");
				  count++;
			      }
			  });
		  } catch (e){
		      $("#"+listId).append("<li><a href=\"" + rssUrl + "\">Error getting rss url " + rssUrl + "</a></li>");
		      alert("Error Message: " + e);
		      return;
		  }

		  YANA.refreshListView(listId);
	      });
};
